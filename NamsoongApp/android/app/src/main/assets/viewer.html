<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>PDF Viewer</title>
    
    <!-- 1. PDF.js Library (LOADING LOCALLY) -->
    <!-- Make sure you have these files in /android/app/src/main/assets/js/ -->
    <script src="./js/pdf.min.js"></script>
    <script src="./js/pdf.worker.min.js"></script>

    <!-- 2. FIX for INVISIBLE SELECTION: Load the official PDF.js CSS (LOCALLY) -->
    <!-- Make sure you have this file in /android/app/src/main/assets/css/ -->
    <link rel="stylesheet" href="./css/pdf_viewer.min.css" />

    <style>
      body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #F0F0F0; }
      #pdf-viewer {
        width: 100%;
        height: 100%;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
      }
      #page-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px 0;
      }
      .page {
        position: relative;
        margin-bottom: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
    </style>
  </head>
  <body>
    
    <div id="pdf-viewer">
      <div id="page-container"></div>
    </div>

    <script>
      // 3. Setup PDF.js (loading worker locally)
      const pdfjsLib = window["pdfjs-dist/build/pdf"];
      pdfjsLib.GlobalWorkerOptions.workerSrc = "./js/pdf.worker.min.js";
      
      const pageContainer = document.getElementById("page-container");
      const viewer = document.getElementById("pdf-viewer");
      let currentPdf = null;
      let currentPage = 1;
      let totalPages = 0;
      let renderedPages = new Set();
      const RENDER_SCALE = 2.0; 

      // 4. PostMessage bridge
      const postMessage = (message) => {
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify(message));
        }
      };
      
      // 5. On-Demand Page Renderer
      const renderPage = async (pageNum) => {
        if (renderedPages.has(pageNum) || !currentPdf) return;
        renderedPages.add(pageNum);
        try {
          const page = await currentPdf.getPage(pageNum);
          const viewport = page.getViewport({ scale: RENDER_SCALE });
          const pageDiv = document.getElementById(`page-${pageNum}`);
          pageDiv.style.width = viewport.width + 'px';
          pageDiv.style.height = viewport.height + 'px';

          const canvas = document.createElement("canvas");
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          
          const textLayerDiv = document.createElement("div");
          textLayerDiv.className = "textLayer";
          textLayerDiv.style.width = viewport.width + 'px';
          textLayerDiv.style.height = viewport.height + 'px';

          pageDiv.appendChild(canvas);
          pageDiv.appendChild(textLayerDiv);

          await page.render({
            canvasContext: canvas.getContext("2d"),
            viewport: viewport,
          }).promise;

          const textContent = await page.getTextContent();
          pdfjsLib.renderTextLayer({
            textContentSource: textContent,
            container: textLayerDiv,
            viewport: viewport,
            textDivs: [],
          });
        } catch (err) {
          console.error(`Failed to render page ${pageNum}`, err);
        }
      };

      // 6. Scroll queue
      const queueRender = () => {
        if (!currentPdf) return;
        const viewerRect = viewer.getBoundingClientRect();
        let visiblePage = 1;
        for (let i = 1; i <= totalPages; i++) {
          const pageDiv = document.getElementById(`page-${i}`);
          if (!pageDiv) continue; 
          const pageRect = pageDiv.getBoundingClientRect();
          const isVisible = (pageRect.bottom >= viewerRect.top - 500) && (pageRect.top <= viewerRect.bottom + 500);
          if (isVisible) {
            if (pageRect.top <= viewerRect.top + 100) visiblePage = i;
            renderPage(i);
            renderPage(i + 1);
          }
        }
        if (visiblePage !== currentPage) {
          currentPage = visiblePage;
          postMessage({ type: 'PAGE_CHANGED', page: currentPage, totalPages: totalPages });
        }
      };

      // 7. Function to load the PDF
      const loadPdf = async (pdfFilename) => {
        try {
          // --- FIX: We load from the local server using the filename ---
          const pdfUrl = `http://localhost:8080/${encodeURIComponent(pdfFilename)}`;
          const loadingTask = pdfjsLib.getDocument(pdfUrl); 
          
          currentPdf = await loadingTask.promise;
          totalPages = currentPdf.numPages;
          postMessage({ type: 'LOAD_COMPLETE', totalPages: totalPages });
          
          pageContainer.innerHTML = '';
          renderedPages.clear();
          
          // Create placeholders for all pages
          const pagePromises = [];
          for (let i = 1; i <= totalPages; i++) {
            pagePromises.push(currentPdf.getPage(i));
          }
          const pages = await Promise.all(pagePromises);
          pages.forEach((page, i) => {
            const pageNum = i + 1;
            const viewport = page.getViewport({ scale: RENDER_SCALE });
            const pageDiv = document.createElement("div");
            pageDiv.id = `page-${pageNum}`;
            pageDiv.style.width = viewport.width + 'px';
            pageDiv.style.height = viewport.height + 'px';
            pageDiv.className = "page";
            pageContainer.appendChild(pageDiv);
          });
          
          await renderPage(1);
          await renderPage(2);
          
          viewer.addEventListener('scroll', queueRender);
        } catch (err) {
          postMessage({ type: 'ERROR', message: err.message });
        }
      };

      // 8. Selection listener
      document.addEventListener("selectionchange", () => {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();
        postMessage({ 
          type: 'SELECTION_CHANGED', 
          text: selectedText, 
          page: currentPage 
        });
      });
      
      // 9. Message listener (from React Native)
      document.addEventListener("message", (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'LOAD_PDF') {
          // --- FIX: We load using the FILENAME ---
          loadPdf(data.filename); 
        }
      });
    </script>
  </body>
</html>